---
title: "prophet-model"
author: "Margaret Reed"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-library}
library(tidyverse)
library(prophet)
library(readxl)
library(janitor)
library(lubridate)
library(scales)
library(MLmetrics)
library(timeDate)
```


```{r load-data}
data1 <- read_excel("online_retail_ii.xlsx", sheet = 1)
data2 <- read_excel("online_retail_ii.xlsx", sheet = 2)
```


```{r clean-data}
data <- data1 %>%
  rbind(data2) %>%
  clean_names()

data <- data %>%
  mutate(
    revenue = quantity*price,
    date = ymd(as.Date(invoice_date)),
    year = year(as.Date(date)),
    month = month(date),
    hour = hour(invoice_date)
    )
```

```{r}
daily_uk <- data %>%
  filter(country == "United Kingdom", revenue > 0) %>%
  group_by(date) %>%
  summarize(daily_revenue = sum(revenue))
```


```{r}
hourly_uk <- data %>%
  filter(country == "United Kingdom", revenue > 0) %>%
  group_by(date, hour) %>%
  summarize(hourly_revenue = sum(revenue), .groups = "drop")
```


```{r}
p_data <- daily_uk %>%
  select(date, daily_revenue) %>%
  rename(ds = date, y = daily_revenue)


x <- dim(p_data)[1]
y <- round(x*0.9, 0)
z <- x - y

training <- p_data %>% slice(1:544)
# validation <- p_data %>% slice(y+1:y+round(z/2, 0))
testing <- p_data %>% slice_tail(n=z)
```


```{r}
uk_holidays <- tibble(ds = holidayLONDON(year = 2009:2011) %>%
  as.Date(),
  holiday = "holiday")
```


# https://facebook.github.io/prophet/docs/quick_start.html#r-api

```{r}
m <- prophet(
  training, 
  holidays = uk_holidays, 
  seasonality.mode = "additive", 
  seasonality.prior.scale	= 0.000001,
  changepoint.prior.scale = 0.025,
  weekly.seasonality = 10,
  yearly.seasonality = F,
  daily.seasonality = 10,
  changepoint.range = 0.8,
  n.changepoints = 30
  )
```


```{r}
future <- make_future_dataframe(m, periods = 60, freq = "day")
```


```{r}
forecast <- predict(m, future)
#tail(forecast[c('ds', 'yhat', 'yhat_lower', 'yhat_upper')])
```


```{r}
pred <- forecast %>%
  slice_tail(n=z) %>%
  pull(yhat)
true <- testing %>%
  pull(y)

MAPE(pred[1:20], true[1:20])
MAPE(pred[21:40], true[21:40])
MAPE(pred[41:60], true[41:60])
```

```{r}
cbind(testing, pred) %>%
  ggplot(aes(x = ds)) +
  geom_line(aes(y = y), color = "black") +
  geom_line(aes(y = pred), color = "blue") +
  scale_y_continuous(labels = label_dollar(
    scale = .001, 
    suffix = "k",
    prefix = "Â£"
    )) +
  labs(
    x = "Date",
    y = "Revenue (sterling)",
    title = "Predicted vs actual revenue during last two months of data",
    subtitle = "Actual (black), predicted (blue)"
  ) +
  theme_minimal()
```

