---
title: "prophet-model"
author: "Margaret Reed"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-library}
library(tidyverse)
library(prophet)
library(readxl)
library(janitor)
library(lubridate)
library(scales)
library(MLmetrics)
```


```{r load-data}
data1 <- read_excel("online_retail_ii.xlsx", sheet = 1)
data2 <- read_excel("online_retail_ii.xlsx", sheet = 2)
```


```{r clean-data}
data <- data1 %>%
  rbind(data2) %>%
  clean_names()

data <- data %>%
  mutate(
    revenue = quantity*price,
    date = ymd(as.Date(invoice_date)),
    year = year(as.Date(date)),
    month = month(date),
    hour = hour(invoice_date)
    )
```

```{r}
daily_uk <- data %>%
  filter(country == "United Kingdom", revenue > 0) %>%
  group_by(date) %>%
  summarize(daily_revenue = sum(revenue))
```


```{r}
hourly_uk <- data %>%
  filter(country == "United Kingdom", revenue > 0) %>%
  group_by(date, hour) %>%
  summarize(hourly_revenue = sum(revenue), .groups = "drop")
```


```{r}
p_data <- daily_uk %>%
  select(date, daily_revenue) %>%
  rename(ds = date, y = daily_revenue)


x <- dim(p_data)[1]
y <- round(x*0.9, 0)
z <- x - y

training <- p_data %>% slice(1:544)
# validation <- p_data %>% slice(y+1:y+round(z/2, 0))
testing <- p_data %>% slice_tail(n=z)
```


```{r}
m <- prophet(training)
```
```{r}
future <- make_future_dataframe(m, periods = 60, freq = "day")
```


```{r}
forecast <- predict(m, future)
tail(forecast[c('ds', 'yhat', 'yhat_lower', 'yhat_upper')])
```

```{r}
prophet_plot_components(m, forecast)
```


```{r}
pred <- forecast %>%
  slice_tail(n=z) %>%
  pull(yhat)
true <- testing %>%
  pull(y)

MAPE(pred, true)
```


