---
title: "sales-eda"
author: "Margaret Reed"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 data : https://archive.ics.uci.edu/ml/datasets/Online+Retail+II

```{r load-pkgs}
library(tidyverse)
library(readxl)
library(janitor)
library(lubridate)
library(scales)
library(forecast)
```

```{r load-data}
data <- read_excel("online_retail_ii.xlsx")
```

```{r clean-data}
data <- data %>%
  clean_names()
```

```{r}
data %>% 
  count(country) %>%
  arrange(desc(n))
```

```{r}
data %>%
  count(description) %>%
  arrange(desc(n))
```

```{r}
data %>%
  group_by(country) %>%
  summarize(
    total_quantity = sum(quantity),
    total_revenue = sum(quantity*price)
    ) %>%
  arrange(desc(total_revenue))
```

```{r}
data <- data %>%
  mutate(
    revenue = quantity*price,
    date = ymd(as.Date(invoice_date)),
    year = year(as.Date(date)),
    month = month(date)
    )
```

```{r}
data %>%
  filter(revenue > 0) %>%
  group_by(date, country) %>%
  summarize(daily_revenue = sum(revenue)) %>%
  filter(country == "United Kingdom") %>%
  ggplot(aes(x = date, y = daily_revenue)) +
  geom_point() +
  geom_smooth(se = F) +
  scale_y_continuous(labels = label_dollar(
    scale = .001, 
    suffix = "k",,
    prefix = "£"
    )) +
  labs(
    x = "Date", 
    y = "Daily revenue",
    title = "Daily revenue over time",
    subtitle = "In the United Kingdom"
  ) +
  theme_minimal()
```

```{r}
data %>%
  mutate(date = lubridate::ymd(as.Date(invoice_date)))
```

```{r}
data %>%
  filter(revenue > 0) %>%
  group_by(month, year, country) %>%
  summarize(monthly_revenue = sum(revenue)) %>%
  filter(country == "United Kingdom") %>%
  ggplot(aes(x = my(paste0(month, "-", year)), y = monthly_revenue)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(labels = label_dollar(
    scale = .000001, 
    suffix = "M", 
    accuracy = .1,
    prefix = "£"
    )) +
  labs(
    x = "Date", 
    y = "Monthly revenue",
    title = "Monthly revenue over time",
    subtitle = "In the United Kingdom"
  ) +
  theme_minimal()
```


```{r}
data %>%
  filter(revenue > 0) %>%
  group_by(date, country) %>%
  summarize(daily_revenue = sum(revenue)) %>%
  filter(country == "United Kingdom") %>%
  ggplot(aes(x = date, y = daily_revenue)) +
  geom_line() +
  geom_smooth(se = F) +
  scale_y_continuous(labels = label_dollar(
    scale = .001, 
    suffix = "k",
    prefix = "£"
    )) +
  labs(
    x = "Date", 
    y = "Daily revenue",
    title = "Daily revenue over time",
    subtitle = "In the United Kingdom"
  ) +
  theme_minimal()
```

source: https://www.simplilearn.com/tutorials/data-science-tutorial/time-series-forecasting-in-r#:~:text=Time%20series%20forecasting%20is%20the,as%20a%20time%20series%20data.


```{r}
daily_uk <- data %>%
  filter(country == "United Kingdom") %>%
  group_by(date) %>%
  summarize(daily_revenue = sum(revenue))
mymodel <- auto.arima(daily_uk %>% pull(daily_revenue))
```

```{r}
plot.ts(mymodel$residuals)
```

```{r}
myforecast <- forecast(mymodel, level=c(70), h=100)
plot(myforecast)
```

https://www.pluralsight.com/guides/time-series-forecasting-using-r

